<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Arrest Helper by Hugo Waffles</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --accent: #22c55e;
      --accent-2: #2563eb;
      --border: #1f2937;
      --text: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(37,99,235,0.15), transparent 30%),
                  radial-gradient(circle at 90% 10%, rgba(34,197,94,0.12), transparent 25%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 18px;
    }
    h1 { margin: 0 0 4px 0; letter-spacing: 0.5px; }
    p { margin: 0 0 14px 0; color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    label { font-weight: 600; font-size: 13px; display: block; margin-bottom: 6px; color: var(--muted); }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1222;
      color: var(--text);
      font-size: 14px;
    }
    button {
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      transition: transform 0.08s ease, box-shadow 0.12s ease;
    }
    button.primary {
      background: linear-gradient(135deg, var(--accent-2), #1d4ed8);
      border: none;
      box-shadow: 0 8px 20px rgba(37,99,235,0.35);
    }
    button.secondary {
      background: #111827;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 14px;
    }
    th { color: var(--muted); font-weight: 700; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .row.three { grid-template-columns: 1fr 1fr 120px; }
    .flex {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .totals {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .badge {
      background: #0b1222;
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
    }
    .muted { color: var(--muted); font-size: 13px; }
    .checklist-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .checklist-item input { width: auto; }
    textarea { resize: vertical; min-height: 90px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #0b1222;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .pill strong { color: var(--text); }
  </style>
</head>
<body>
  <div class="card" style="margin-bottom:12px;">
    <strong>Miranda Rights</strong>
    <p>You have the right to remain silent,</p>
    <p>Anything you say can and will be used against you in the court of law.</p>
    <p>You have the right to an attorney,</p>
    <p>If you cannot afford an attorney, one will be appointed to you by the state if available.</p>
    <p>Do you understand the rights I just read to you?</p>
  </div>
  <h1>Arrest Helper by Hugo Waffles</h1>
  <p>Pick charges fast, auto-sum fines/stars, and work through the RP checklist.</p>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div style="grid-column: 1 / -1;">
          <label for="search">Quick filter (PC + TC)</label>
          <input id="search" type="text" placeholder="Type to filter by code or name">
        </div>
      </div>
      <div class="row three" style="margin-top:10px;">
        <div>
          <label for="pcSelect">Penal Code (PC)</label>
          <select id="pcSelect"><option>Loading PC...</option></select>
          <button class="primary" id="addPcBtn" style="margin-top:6px;">Add Penal</button>
        </div>
        <div>
          <label for="tcSelect">Traffic Code (TC)</label>
          <select id="tcSelect"><option>Loading TC...</option></select>
          <button class="primary" id="addTcBtn" style="margin-top:6px;">Add Traffic</button>
        </div>
        <div>
          <label for="qty">Qty</label>
          <input id="qty" type="number" min="1" value="1">
        </div>
      </div>

      <div class="totals">
        <div class="badge">Total Fine: $<span id="totalFine">0</span></div>
        <div class="badge">Total Stars: <span id="totalStars">0</span></div>
        <div class="badge">Charges: <span id="totalCount">0</span></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Code</th>
            <th>Charge</th>
            <th>Fine</th>
            <th>Stars</th>
            <th>Qty</th>
            <th>Subtotals</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="chargeRows"></tbody>
      </table>

      <div class="flex" style="margin-top:12px;">
        <button class="secondary" id="copyBtn">Copy summary</button>
        <button class="secondary" id="copyCodesBtn">Copy codes</button>
        <button class="secondary" id="clearBtn">Clear list</button>
        <button class="secondary" id="loadSheetsBtn">Reload PC/TC files FOR OFFLINE USE ONLY DONT TOUCH </button>
        <span class="pill" id="dataStatus"><strong>Status:</strong> Loading local PC/TC sheets...</span>
      </div>
      <input type="file" id="sheetPicker" accept=".html,text/html" multiple style="display:none">
    </div>

    <div class="card">
      <div class="flex" style="justify-content: space-between; margin-bottom: 10px;">
        <h3 style="margin:0;">RP Guide</h3>
       <!-- <span class="muted">Progress saves locally</span> -->
      </div>
      <div id="checklist"></div>
      <label for="notes" style="margin-top:10px;">Notes</label>
      <textarea id="notes" placeholder="Quick notes, badge numbers, lawyer info, etc."></textarea>
      <div class="flex" style="margin-top:10px;">
        <button class="secondary" id="resetChecklist">Reset checklist</button>
      </div>
    </div>
  </div>

      <script>
    const checklistItems = [
      "/me takes out bodycam, turns it on and checks for the red light",
      "If Code A /me refreshes bodycam",
      "/do The bodycam is recording, and is ballistic and waterproof",
      "/do saves and uploads the bodycam content to LSPD servers and continues recording",
      "/me Extracts the SD Card from the bodycam and inserts it into the PDA.",
      "/me Displays bodycam on PDA to the lawyer ",
      "When Breaking trunk  /me pulls out crowbar from vest and uses it to break into trunk |  /do trunk is open",
      "DOC intake: ask jumpsuit size (/me reaches behind desk and grabs a <size> jumpsuit |  /me puts jumpsuit on bed",
      "PDA: enter each charge separately; apply fines/stars; confirm totals with suspect",
      "/do saves and uploads bodycam to LSPD servers; dispatch 10-99, 10-19"
    ];

    const pcSelect = document.getElementById("pcSelect");
    const tcSelect = document.getElementById("tcSelect");
    const searchInput = document.getElementById("search");
    const qtyInput = document.getElementById("qty");
    const rowsEl = document.getElementById("chargeRows");
    const totalFineEl = document.getElementById("totalFine");
    const totalStarsEl = document.getElementById("totalStars");
    const totalCountEl = document.getElementById("totalCount");
    const checklistEl = document.getElementById("checklist");
    const notesEl = document.getElementById("notes");
    const dataStatus = document.getElementById("dataStatus");
    const sheetPicker = document.getElementById("sheetPicker");
    const stateKey = "arrest-helper-state-v2";
    const chargesCacheKey = "arrest-helper-charges-cache-v1";

    let selections = [];
    let checklistState = [];
    let pcCharges = [];
    let tcCharges = [];

    function setStatus(text) {
      if (dataStatus) dataStatus.textContent = text;
    }

    function saveState() {
      const payload = { selections, checklistState, notes: notesEl.value };
      try { localStorage.setItem(stateKey, JSON.stringify(payload)); } catch (e) { /* ignore */ }
    }

    function loadState() {
      try {
        const stored = JSON.parse(localStorage.getItem(stateKey) || "null");
        if (!stored) return;
        selections = stored.selections || [];
        checklistState = stored.checklistState || [];
        notesEl.value = stored.notes || "";
      } catch (e) {
        selections = [];
        checklistState = [];
      }
    }

    function renderOptions(filter = "") {
      const term = filter.toLowerCase();
      const render = (selectEl, data, label) => {
        selectEl.innerHTML = "";
        const filtered = data.filter(c => (c.name + c.code).toLowerCase().includes(term));
        if (!filtered.length) {
          const opt = document.createElement("option");
          opt.textContent = `No ${label} matches`;
          selectEl.appendChild(opt);
          return;
        }
        filtered.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.code;
          opt.textContent = `${c.code} - ${c.name} ($${c.fine} | ${c.stars}*)`;
          selectEl.appendChild(opt);
        });
      };
      render(pcSelect, pcCharges, "PC");
      render(tcSelect, tcCharges, "TC");
    }

    function renderChecklist() {
      checklistEl.innerHTML = "";
      checklistItems.forEach((text, idx) => {
        const wrapper = document.createElement("div");
        wrapper.className = "checklist-item";
        const box = document.createElement("input");
        box.type = "checkbox";
        box.checked = checklistState[idx] === true;
        box.addEventListener("change", () => {
          checklistState[idx] = box.checked;
          saveState();
        });
        const label = document.createElement("label");
        label.textContent = text;
        wrapper.appendChild(box);
        wrapper.appendChild(label);
        checklistEl.appendChild(wrapper);
      });
    }

    function renderTable() {
      rowsEl.innerHTML = "";
      let fineSum = 0;
      let starsSum = 0;
      let countSum = 0;

      selections.forEach((item, idx) => {
        const fineSub = item.fine * item.qty;
        fineSum += fineSub;
        starsSum += (item.stars || 0) * item.qty;
        countSum += item.qty;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.type}</td>
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>$${item.fine}</td>
          <td>${item.stars || 0}*</td>
          <td>${item.qty}</td>
          <td>$${fineSub} / ${(item.stars || 0) * item.qty}*</td>
          <td><button class="secondary" data-idx="${idx}">Remove</button></td>
        `;
        rowsEl.appendChild(tr);
      });

      totalFineEl.textContent = fineSum;
      const displayedStars = Math.min(5, starsSum);
      totalStarsEl.textContent = displayedStars;
      totalCountEl.textContent = countSum;
    }

    function addCharge(type) {
      const qty = Math.max(1, Number(qtyInput.value) || 1);
      const pool = type === "PC" ? pcCharges : tcCharges;
      const selectEl = type === "PC" ? pcSelect : tcSelect;
      const code = selectEl.value;
      const charge = pool.find(c => c.code === code);
      if (!charge) return;
      selections.push({ ...charge, type, qty });
      qtyInput.value = 1;
      renderTable();
      saveState();
    }

    function copySummary() {
      if (!selections.length) return;
      const lines = selections.map(item => {
        return `${item.type} ${item.code} ${item.name} x${item.qty} -> $${item.fine * item.qty}, ${(item.stars || 0) * item.qty}*`;
      });
      lines.push(`Total: $${totalFineEl.textContent}, ${totalStarsEl.textContent}*, charges: ${totalCountEl.textContent}`);
      const text = lines.join("\n");
      navigator.clipboard.writeText(text).catch(() => {});
    }

    function copyCodes() {
      if (!selections.length) return;
      const codes = selections.map(item => `${item.code}`);
      const text = codes.join(", ");
      navigator.clipboard.writeText(text).then(() => {
        setStatus("Copied codes to clipboard");
        setTimeout(() => setStatus(""), 2000);
      }).catch(() => {
        // fallback: prompt so user can copy manually
        window.prompt("Copy the codes below:", text);
      });
    }

    function parseMoney(text) {
      const digits = (text || "").replace(/[^\d]/g, "");
      return digits ? Number(digits) : 0;
    }

    function countStars(text) {
      if (!text) return 0;
      const raw = String(text).trim();
      // Prefer explicit star glyphs or '*' characters
      const starIcons = raw.match(/[\*\u2605\u2606\u2B50]/g);
      if (starIcons) return starIcons.length;
      // Look for explicit phrases like "1 star", "2 stars"
      const wordMatch = raw.match(/(\d+)\s*(?:star|stars|st)\b/i);
      if (wordMatch) return Math.min(5, Number(wordMatch[1]));
      // If there's a small number (1-5) present, treat it as stars; ignore larger numbers (likely fines)
      const numMatch = raw.replace(/[$,]/g, '').match(/\d+/);
      if (numMatch) {
        const n = Number(numMatch[0]);
        if (n > 0 && n <= 5) return n;
      }
      return 0;
    }

    function parseCharges(doc, prefix) {
      const rows = Array.from(doc.querySelectorAll("table.waffle tr"));
      const list = [];

      // Helper to test a cell for a code like "PC" or "TC" prefix
      const codeRegex = new RegExp(`^\\s*${prefix}\\b`, 'i');

      rows.forEach(tr => {
        const tds = Array.from(tr.querySelectorAll("td"));
        if (!tds.length) return;

        const cells = tds.map(td => ({ el: td, text: (td.textContent || "").trim() }));

        // Find the cell that contains the code (e.g. "PC 2.1.1" or "TC 3.1.4")
        const codeCellIndex = cells.findIndex(c => codeRegex.test(c.text));
        if (codeCellIndex === -1) return;

        const rawCode = cells[codeCellIndex].text.replace(/\s+/g, ' ').trim();

        // Name should be the next non-empty cell after the code
        let name = '';
        for (let i = codeCellIndex + 1; i < cells.length; i++) {
          if (cells[i].text) { name = cells[i].text; break; }
        }

        // Fine: look for a nearby cell that contains a $ or digits or the word Variable or a dash
        let fineText = '';
        for (let i = codeCellIndex + 1; i < Math.min(cells.length, codeCellIndex + 5); i++) {
          const t = cells[i].text || '';
          if (/\$|\d|variable|\-|impound|towing|extra|OR\s+towing/i.test(t)) { fineText = t; break; }
        }
        // If we didn't find fine after the code, also check before the code (some sheets vary)
        if (!fineText) {
          for (let i = Math.max(0, codeCellIndex - 3); i < codeCellIndex; i++) {
            const t = cells[i].text || '';
            if (/\$|\d|variable|\-|impound|towing|extra|OR\s+towing/i.test(t)) { fineText = t; break; }
          }
        }

        // Stars: search nearby cells for star glyphs or words
        let starsText = '';
        for (let i = codeCellIndex + 1; i < Math.min(cells.length, codeCellIndex + 6); i++) {
          const t = cells[i].text || '';
          if (/[*\u2605\u2606\u2B50|â­]|\bstar(s)?\b|\d+\s*(?:star|stars|st)\b/i.test(t)) { starsText = t; break; }
        }

        const fine = parseMoney(fineText);
        const stars = countStars(starsText);

        if (!rawCode || !name) return;

        list.push({ code: rawCode, name, fine, fineText, stars, starsText });
      });

      return list;
    }

    function parseChargesFromText(html, prefix) {
      const doc = new DOMParser().parseFromString(html, "text/html");
      return parseCharges(doc, prefix);
    }

    async function loadSheet(path, prefix) {
      const resp = await fetch(path, { cache: "no-store" });
      if (!resp.ok) throw new Error(`Failed to load ${path}: ${resp.status}`);
      const html = await resp.text();
      return parseChargesFromText(html, prefix);
    }

    function cacheCharges() {
      try {
        localStorage.setItem(chargesCacheKey, JSON.stringify({ pc: pcCharges, tc: tcCharges }));
      } catch (e) { /* ignore */ }
    }

    function loadChargesFromCache() {
      try {
        const cached = JSON.parse(localStorage.getItem(chargesCacheKey) || "null");
        if (cached?.pc?.length || cached?.tc?.length) {
          pcCharges = cached.pc || [];
          tcCharges = cached.tc || [];
          return true;
        }
      } catch (e) { /* ignore */ }
      return false;
    }

    function ensureFallbackData() {
      if (!pcCharges.length) pcCharges = [{ code: "PC SAMPLE", name: "Sample Penal", fine: 0, stars: 0 }];
      if (!tcCharges.length) tcCharges = [{ code: "TC SAMPLE", name: "Sample Traffic", fine: 0, stars: 0 }];
    }

    async function tryAutoLoad() {
      try {
        const [pc, tc] = await Promise.all([
          loadSheet("Penal Code.html", "PC"),
          loadSheet("Traffic Code.html", "TC")
        ]);
        pcCharges = pc;
        tcCharges = tc;
        cacheCharges();
        renderOptions(searchInput.value);
        setStatus("Loaded PC/TC from files in this folder.");
        console.info('Arrest Helper: parsed PC entries=', pcCharges.length, 'TC entries=', tcCharges.length);
        // Log a small sample for quick verification
        console.info('PC sample:', pcCharges.slice(0,6));
        console.info('TC sample:', tcCharges.slice(0,6));
        return true;
      } catch (e) {
        console.warn("Auto load failed", e);
        return false;
      }
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error || new Error("File read failed"));
        reader.readAsText(file);
      });
    }

    async function loadFromPicker(fileList) {
      const files = Array.from(fileList || []);
      const pcFile = files.find(f => /penal code\.html/i.test(f.name));
      const tcFile = files.find(f => /traffic code\.html/i.test(f.name));
      if (!pcFile && !tcFile) {
        setStatus("Pick Penal Code.html and Traffic Code.html from this folder.");
        return;
      }
      if (pcFile) pcCharges = parseChargesFromText(await readFileAsText(pcFile), "PC");
      if (tcFile) tcCharges = parseChargesFromText(await readFileAsText(tcFile), "TC");
      cacheCharges();
      renderOptions(searchInput.value);
      setStatus("Loaded PC/TC from selected files.");
    }

    pcSelect.addEventListener("change", () => qtyInput.focus());
    tcSelect.addEventListener("change", () => qtyInput.focus());
    searchInput.addEventListener("input", e => renderOptions(e.target.value));
    document.getElementById("addPcBtn").addEventListener("click", () => addCharge("PC"));
    document.getElementById("addTcBtn").addEventListener("click", () => addCharge("TC"));
    document.getElementById("copyBtn").addEventListener("click", copySummary);
    document.getElementById("copyCodesBtn").addEventListener("click", copyCodes);
    document.getElementById("clearBtn").addEventListener("click", () => {
      selections = [];
      renderTable();
      saveState();
    });
    document.getElementById("loadSheetsBtn").addEventListener("click", () => sheetPicker.click());
    sheetPicker.addEventListener("change", e => {
      if (e.target.files?.length) {
        loadFromPicker(e.target.files);
      }
      e.target.value = "";
    });
    rowsEl.addEventListener("click", e => {
      if (e.target.tagName === "BUTTON" && e.target.dataset.idx) {
        const idx = Number(e.target.dataset.idx);
        selections.splice(idx, 1);
        renderTable();
        saveState();
      }
    });
    notesEl.addEventListener("input", saveState);
    document.getElementById("resetChecklist").addEventListener("click", () => {
      checklistState = [];
      renderChecklist();
      saveState();
    });

    loadState();
    renderTable();
    renderChecklist();
    const hadCache = loadChargesFromCache();
    if (hadCache) {
      renderOptions(searchInput.value);
      setStatus("Using cached PC/TC data. Reload to refresh from files.");
    } else {
      setStatus("Loading PC/TC sheets from this folder...");
    }

    tryAutoLoad().then(success => {
      if (!success) {
        ensureFallbackData();
        renderOptions(searchInput.value);
        setStatus("Browser blocked auto-read. Click 'Reload PC/TC files' and pick Penal Code.html and Traffic Code.html from this folder.");
      }
    });
  </script>
</body>
</html>




